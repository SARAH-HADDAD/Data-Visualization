<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Stacked Bar Chart</title>
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v4.js"></script>
</head>
<body>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>

<script>
    // set the dimensions and margins of the graph
    var margin = { top: 10, right: 30, bottom: 20, left: 50 },
        width = 460 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    var svg = d3
        .select("#my_dataviz")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // Load the CSV file
    d3.csv("penguins.csv", function (data) {
        console.log("Loaded data:", data); // Log the loaded data

        // Create a nested structure for each island
        var nestedData = d3.nest()
            .key(function (d) { return d.island; })
            .key(function (d) { return d.species; })
            .rollup(function (values) { return values.length; })
            .entries(data);

        // Convert the nested structure to an array
        var processedData = nestedData.map(function (d) {
            var island = d.key;
            var speciesData = d.values.map(function (species) {
                return { species: species.key, value: species.value };
            });

            return { island: island, speciesData: speciesData };
        });

        console.log("Processed data:", processedData); // Log the processed data

        // Extract unique species from all islands
        var species = Array.from(new Set(data.map(d => d.species)));

        // Add X axis
        var x = d3.scaleBand().domain(processedData.map(d => d.island)).range([0, width]).padding([0.2]);
        svg
            .append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x).tickSizeOuter(0));

        // Add Y axis
        var y = d3.scaleLinear().domain([0, d3.max(processedData, function (d) {
            return d3.sum(d.speciesData, function (species) {
                return species.value;
            });
        })]).range([height, 0]);
        svg.append("g").call(d3.axisLeft(y));

        // color palette
        var color = d3.scaleOrdinal().domain(species).range(['#e41a1c', '#377eb8', '#4daf4a']); // Add more colors if needed

        // Show the bars
        svg
            .selectAll(".barGroup")
            .data(processedData)
            .enter()
            .append("g")
            .attr("class", "barGroup")
            .attr("transform", function (d) {
                return "translate(" + x(d.island) + ",0)";
            })
            .selectAll("rect")
            .data(function (d) {
                return d.speciesData;
            })
            .enter()
            .append("rect")
            .attr("x", 0)
            .attr("y", function (d) {
                return y(d.value);
            })
            .attr("height", function (d) {
                return height - y(d.value);
            })
            .attr("width", x.bandwidth())
            .attr("fill", function (d) {
                return color(d.species);
            });
    });
</script>

</body>
</html>
